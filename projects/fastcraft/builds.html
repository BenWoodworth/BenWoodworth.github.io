<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FastCraft Builds</title>
</head>
<body>
    <table id="builds" border="1px">
        <thead>
            <tr>
                <td>Status</td>
                <td>Build#</td>
                <td>Commit</td>
                <td>Message</td>
                <td>Download</td>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        var awsResponse = null;
        var travisResponse = null;

        var awsRequest = new XMLHttpRequest();
        awsRequest.open("GET", "http://s3.amazonaws.com/fastcraft", true);
        awsRequest.send(null);
        awsRequest.onreadystatechange = function() {
            if (awsRequest.readyState === 4 && awsRequest.status === 200) {
                awsResponse = awsRequest.responseXML;
                render();
            }
        };

        var travisRequest = new XMLHttpRequest();
        travisRequest.open("GET", "https://api.travis-ci.org/repos/BenWoodworth/FastCraft/builds", true);
        travisRequest.send(null);
        travisRequest.onreadystatechange = function() {
            if (travisRequest.readyState === 4 && travisRequest.status === 200) {
                travisResponse = JSON.parse(travisRequest.response);
                render();
            }
        };

        var rendered = false;
        function render() {
            if (rendered || awsResponse === null || travisResponse === null) {
                return;
            }
            rendered = true;

            var builds = [];
            for (var i in travisResponse) {
                var travisBuild = travisResponse[i];

                var buildNumber = parseInt(travisBuild.number);

                var buildStatus = "building";
                if (travisBuild.state === "finished") {
                    if (travisBuild.result === 0) {
                        buildStatus = "passed"
                    } else {
                        buildStatus = "failed"
                    }
                }

                builds[buildNumber] = {
                    id: travisBuild.id,
                    number: buildNumber,
                    branch: travisBuild.branch,
                    status: buildStatus,
                    commit: travisBuild.commit,
                    commit_short: travisBuild.commit.substr(0, 7),
                    message: travisBuild.message,
                    file: null
                };
            }

            var awsContents = awsResponse.getElementsByTagName("Contents");
            for (var i = 0; i < awsContents.length; i++) {
                var content = awsContents[i];
                var key = content.getElementsByTagName("Key")[0].textContent;
                var size = content.getElementsByTagName("Size")[0].textContent;

                var r = /^builds\/[^/]+\/([0-9]+)\/(.*)$/.exec(key);
                var buildNumber = parseInt(r[1]);
                var filename = r[2];

                var build = builds[buildNumber];
                if (build == null) {
                    continue
                }

                build.file = {
                    url: "https://s3.amazonaws.com/fastcraft/" + key,
                    name: filename,
                    size: size
                }
            }

            var tbody = document.querySelector("#builds > tbody");
            builds.sort(function(a, b) { return b.number - a.number });
            for (var i in builds) {
                var build = builds[i];

                var row = document.createElement("tr");
                tbody.appendChild(row);

                var tdStatus = document.createElement("td");
                row.appendChild(tdStatus);
                switch (build.status) {
                    case "building":
                        tdStatus.innerText = "Building";
                        tdStatus.style.backgroundColor = "#FF7";
                        break;
                    case "passed":
                        tdStatus.innerText = "Passed";
                        tdStatus.style.backgroundColor = "#7F7";
                        break;
                    case "failed":
                        tdStatus.innerText = "Failed";
                        tdStatus.style.backgroundColor = "#F77";
                        break;
                }

                var tdBuildNumber = document.createElement("td");
                row.appendChild(tdBuildNumber);
                var linkBuildNumber = document.createElement("a");
                tdBuildNumber.appendChild(linkBuildNumber);
                linkBuildNumber.href = "https://travis-ci.org/BenWoodworth/FastCraft/builds/" + build.id;
                linkBuildNumber.innerText = build.number;

                var tdCommit = document.createElement("td");
                row.appendChild(tdCommit);
                var linkCommit = document.createElement("a");
                tdCommit.appendChild(linkCommit);
                linkCommit.href = "https://github.com/BenWoodworth/FastCraft/commit/" + build.commit;
                linkCommit.innerText = build.commit_short;

                var tdMessage = document.createElement("td");
                row.appendChild(tdMessage);
                tdMessage.innerText = build.message;

                var tdDownload = document.createElement("td");
                row.appendChild(tdDownload);
                if (build.file != null) {
                    var linkDownload = document.createElement("a");
                    tdDownload.appendChild(linkDownload);
                    linkDownload.href = build.file.url;
                    linkDownload.innerText = build.file.name;
                }
            }
        }
    </script>
</body>
</html>